<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Feedback Processing Study</title>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }
        .animate-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Lucide React Icons as inline SVG components
        const Download = () => (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="7 10 12 15 17 10"></polyline>
                <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
        );

        const User = () => (
            <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                <circle cx="12" cy="7" r="4"></circle>
            </svg>
        );

        const Cpu = () => (
            <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <rect x="4" y="4" width="16" height="16" rx="2" ry="2"></rect>
                <rect x="9" y="9" width="6" height="6"></rect>
                <line x1="9" y1="1" x2="9" y2="4"></line>
                <line x1="15" y1="1" x2="15" y2="4"></line>
                <line x1="9" y1="20" x2="9" y2="23"></line>
                <line x1="15" y1="20" x2="15" y2="23"></line>
                <line x1="20" y1="9" x2="23" y2="9"></line>
                <line x1="20" y1="14" x2="23" y2="14"></line>
                <line x1="1" y1="9" x2="4" y2="9"></line>
                <line x1="1" y1="14" x2="4" y2="14"></line>
            </svg>
        );

        const FeedbackInterface = () => {
            const [stage, setStage] = useState('consent');
            const [participantId, setParticipantId] = useState('');
            const [essayText, setEssayText] = useState('');
            const [condition, setCondition] = useState(null);
            const [feedbackOrder, setFeedbackOrder] = useState([]);
            const [sessionData, setSessionData] = useState({});
            const [timeElapsed, setTimeElapsed] = useState(0);
            const [analyzingTime, setAnalyzingTime] = useState(0);
            const [canContinue, setContinue] = useState(false);
            const [allSessions, setAllSessions] = useState([]);
            
            const feedbackStartTime = useRef(null);
            const firstInteractionTime = useRef(null);
            const pageLoadTime = useRef(null);
            const taskSubmitTime = useRef(null);
            const analyzingStartTime = useRef(null);

            const feedbackItems = {
                positive: [
                    "You interpreted the patterns in a clear and organized way.",
                    "Your reasoning showed effective use of evidence from the prompt.",
                    "You identified relevant features that many respondents overlook.",
                    "Your summary conveyed the main conclusion accurately and concisely."
                ],
                negative: [
                    "You overlooked subtle patterns that would strengthen your conclusion.",
                    "Your justification did not connect claims to specific observations.",
                    "You missed alternative explanations that challenge the initial inference.",
                    "Your summary omitted qualifiers that affect the argument's accuracy."
                ]
            };

            useEffect(() => {
                if (stage === 'analyzing') {
                    const timer = setInterval(() => {
                        setAnalyzingTime(prev => {
                            const newTime = prev + 1;
                            if (newTime >= 120) {
                                clearInterval(timer);
                                setTimeout(() => {
                                    feedbackStartTime.current = Date.now();
                                    setStage('feedback');
                                }, 500);
                            }
                            return newTime;
                        });
                    }, 1000);
                    return () => clearInterval(timer);
                }
            }, [stage]);

            useEffect(() => {
                if (stage === 'feedback' && !canContinue) {
                    const timer = setInterval(() => {
                        setTimeElapsed(prev => prev + 1);
                    }, 1000);
                    if (timeElapsed >= 30) {
                        setContinue(true);
                    }
                    return () => clearInterval(timer);
                }
            }, [stage, timeElapsed, canContinue]);

            useEffect(() => {
                if (stage === 'feedback' && !pageLoadTime.current) {
                    pageLoadTime.current = Date.now();
                }
            }, [stage]);

            const handleConsent = () => {
                setStage('entry');
            };

            const handleStartStudy = () => {
                if (!participantId.trim()) {
                    alert('Please enter your participant ID');
                    return;
                }
                const assignedCondition = Math.random() < 0.5 ? 'human' : 'ai';
                setCondition(assignedCondition);
                setStage('task');
            };

            const handleTaskSubmit = () => {
                if (!essayText.trim() || essayText.trim().split(' ').length < 50) {
                    alert('Please write at least 50 words for your response');
                    return;
                }

                taskSubmitTime.current = Date.now();

                const allFeedback = [
                    ...feedbackItems.positive.map((text, i) => ({ text, valence: 'positive', originalIndex: i })),
                    ...feedbackItems.negative.map((text, i) => ({ text, valence: 'negative', originalIndex: i }))
                ];
                const shuffled = allFeedback.sort(() => Math.random() - 0.5);
                setFeedbackOrder(shuffled);

                const sessionStart = new Date().toISOString();
                setSessionData({
                    participantId: participantId.trim(),
                    condition: condition,
                    sessionStart,
                    essayWordCount: essayText.trim().split(/\s+/).length,
                    feedbackOrder: shuffled.map(f => ({
                        valence: f.valence,
                        originalIndex: f.originalIndex,
                        text: f.text
                    }))
                });

                analyzingStartTime.current = Date.now();
                setStage('analyzing');
            };

            const handleInteraction = () => {
                if (!firstInteractionTime.current) {
                    firstInteractionTime.current = Date.now();
                }
            };

            const handleComplete = () => {
                const feedbackEndTime = Date.now();
                const totalViewingTime = (feedbackEndTime - feedbackStartTime.current) / 1000;
                const timeToFirstInteraction = firstInteractionTime.current 
                    ? (firstInteractionTime.current - feedbackStartTime.current) / 1000 
                    : null;

                const completedSession = {
                    ...sessionData,
                    taskSubmitTimestamp: taskSubmitTime.current ? new Date(taskSubmitTime.current).toISOString() : 'N/A',
                    analyzingDurationSeconds: 120,
                    totalViewingTimeSeconds: totalViewingTime.toFixed(2),
                    timeToFirstInteractionSeconds: timeToFirstInteraction ? timeToFirstInteraction.toFixed(2) : 'N/A',
                    minimumTimeMetSeconds: 30,
                    sessionEnd: new Date().toISOString()
                };

                setSessionData(completedSession);
                setAllSessions(prev => [...prev, completedSession]);
                setStage('complete');
            };

            const downloadCSV = () => {
                const sessions = allSessions.length > 0 ? allSessions : [sessionData];
                
                const headers = [
                    'participantId',
                    'condition',
                    'sessionStart',
                    'essayWordCount',
                    'taskSubmitTimestamp',
                    'analyzingDurationSeconds',
                    'sessionEnd',
                    'totalViewingTimeSeconds',
                    'timeToFirstInteractionSeconds',
                    'minimumTimeMetSeconds',
                    'feedbackOrder'
                ];

                const rows = sessions.map(session => [
                    session.participantId,
                    session.condition,
                    session.sessionStart,
                    session.essayWordCount,
                    session.taskSubmitTimestamp,
                    session.analyzingDurationSeconds,
                    session.sessionEnd,
                    session.totalViewingTimeSeconds,
                    session.timeToFirstInteractionSeconds,
                    session.minimumTimeMetSeconds,
                    JSON.stringify(session.feedbackOrder)
                ]);

                const csvContent = [
                    headers.join(','),
                    ...rows.map(row => row.map(cell => `"${cell}"`).join(','))
                ].join('\n');

                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `pilot_a_data_${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                window.URL.revokeObjectURL(url);
            };

            if (stage === 'consent') {
                return (
                    <div className="min-h-screen bg-gray-50 flex items-center justify-center p-4">
                        <div className="max-w-2xl w-full bg-white rounded-lg shadow-md p-8">
                            <h1 className="text-2xl font-bold text-gray-800 mb-4">Research Study Consent</h1>
                            <div className="space-y-4 text-gray-700 mb-6">
                                <p>You are invited to participate in a research study examining feedback processing.</p>
                                <p>This study will take approximately 12-14 minutes. You will:</p>
                                <ul className="list-disc ml-6 space-y-2">
                                    <li>Review feedback about cognitive task performance</li>
                                    <li>Complete brief questionnaires</li>
                                </ul>
                                <p>Your participation is voluntary and your responses will be kept confidential.</p>
                                <p className="font-semibold">By clicking "I Agree" below, you consent to participate in this study.</p>
                            </div>
                            <button
                                onClick={handleConsent}
                                className="w-full bg-blue-600 text-white py-3 px-6 rounded-md hover:bg-blue-700 transition-colors font-semibold"
                            >
                                I Agree to Participate
                            </button>
                        </div>
                    </div>
                );
            }

            if (stage === 'entry') {
                return (
                    <div className="min-h-screen bg-gray-50 flex items-center justify-center p-4">
                        <div className="max-w-md w-full bg-white rounded-lg shadow-md p-8">
                            <h2 className="text-2xl font-bold text-gray-800 mb-6">Participant Information</h2>
                            <div className="space-y-4">
                                <div>
                                    <label className="block text-gray-700 font-semibold mb-2">
                                        Enter your SONA ID or Participant ID:
                                    </label>
                                    <input
                                        type="text"
                                        value={participantId}
                                        onChange={(e) => setParticipantId(e.target.value)}
                                        className="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                        placeholder="e.g., SONA12345"
                                    />
                                </div>
                                <button
                                    onClick={handleStartStudy}
                                    className="w-full bg-blue-600 text-white py-3 px-6 rounded-md hover:bg-blue-700 transition-colors font-semibold"
                                >
                                    Begin Study
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            if (stage === 'task') {
                const wordCount = essayText.trim().split(/\s+/).filter(word => word.length > 0).length;
                
                return (
                    <div className="min-h-screen bg-gray-50 p-8">
                        <div className="max-w-3xl mx-auto">
                            <div className="bg-white rounded-lg shadow-md p-8">
                                <h2 className="text-2xl font-bold text-gray-800 mb-4">Cognitive Analysis Task</h2>
                                
                                <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                                    <p className="text-gray-700 leading-relaxed">
                                        Please read the following scenario carefully and provide your analysis:
                                    </p>
                                    <div className="mt-4 p-4 bg-white rounded border border-gray-200">
                                        <p className="text-gray-800 font-semibold mb-2">Scenario:</p>
                                        <p className="text-gray-700 leading-relaxed">
                                            A research team collected data on student study habits and exam performance. 
                                            They found that students who studied in shorter, distributed sessions over multiple days 
                                            performed better on average than students who studied in longer, massed sessions close to the exam date. 
                                            However, students who massed their study reported feeling more confident about their preparation.
                                        </p>
                                    </div>
                                </div>

                                <div className="mb-6">
                                    <label className="block text-gray-700 font-semibold mb-2">
                                        Your Analysis (minimum 50 words):
                                    </label>
                                    <p className="text-sm text-gray-600 mb-2">
                                        Interpret these findings. What patterns do you see? What might explain the relationship between 
                                        study habits, performance, and confidence? Consider multiple perspectives in your response.
                                    </p>
                                    <textarea
                                        value={essayText}
                                        onChange={(e) => setEssayText(e.target.value)}
                                        className="w-full px-4 py-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-y"
                                        style={{minHeight: '256px'}}
                                        placeholder="Type your analysis here..."
                                    />
                                    <div className="flex justify-between items-center mt-2">
                                        <span className="text-sm text-gray-500">
                                            Word count: {wordCount} {wordCount < 50 && `(need ${50 - wordCount} more)`}
                                        </span>
                                        {wordCount >= 50 && (
                                            <span className="text-sm text-green-600 font-semibold">✓ Minimum met</span>
                                        )}
                                    </div>
                                </div>

                                <button
                                    onClick={handleTaskSubmit}
                                    disabled={wordCount < 50}
                                    className={`w-full py-3 px-6 rounded-md font-semibold transition-colors ${
                                        wordCount >= 50
                                            ? 'bg-blue-600 text-white hover:bg-blue-700'
                                            : 'bg-gray-300 text-gray-500 cursor-not-allowed'
                                    }`}
                                >
                                    Submit for Analysis
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            if (stage === 'analyzing') {
                const isHuman = condition === 'human';
                const progress = (analyzingTime / 120) * 100;
                const timeRemaining = 120 - analyzingTime;
                const minutesRemaining = Math.floor(timeRemaining / 60);
                const secondsRemaining = timeRemaining % 60;
                
                return (
                    <div className="min-h-screen bg-gray-50 flex items-center justify-center p-4">
                        <div className="max-w-md w-full bg-white rounded-lg shadow-md p-8">
                            <div className="text-center">
                                <div className="mb-6">
                                    {isHuman ? (
                                        <div className="w-20 h-20 bg-gray-400 rounded-full flex items-center justify-center mx-auto animate-pulse">
                                            <User />
                                        </div>
                                    ) : (
                                        <div className="w-20 h-20 bg-gray-700 rounded-lg flex items-center justify-center mx-auto animate-pulse">
                                            <Cpu />
                                        </div>
                                    )}
                                </div>
                                
                                <h2 className="text-2xl font-bold text-gray-800 mb-2">
                                    {isHuman ? 'Analysis in Progress' : 'AI Analysis in Progress'}
                                </h2>
                                
                                <p className="text-gray-600 mb-6">
                                    {isHuman 
                                        ? 'A reviewer is currently reading and evaluating your response...'
                                        : 'The AI system is analyzing your response patterns and quality...'}
                                </p>

                                <div className="mb-4">
                                    <div className="w-full bg-gray-200 rounded-full h-3">
                                        <div 
                                            className="bg-blue-600 h-3 rounded-full transition-all duration-1000"
                                            style={{ width: `${progress}%` }}
                                        />
                                    </div>
                                </div>

                                <p className="text-sm text-gray-500">
                                    Estimated time remaining: {minutesRemaining}:{secondsRemaining.toString().padStart(2, '0')}
                                </p>

                                <div className="mt-6 p-4 bg-gray-50 rounded-lg">
                                    <p className="text-xs text-gray-600 italic">
                                        {isHuman 
                                            ? 'Please wait while the reviewer completes their assessment. This typically takes about 2 minutes.'
                                            : 'Please wait while the AI completes its analysis. This typically takes about 2 minutes.'}
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            if (stage === 'feedback') {
                const isHuman = condition === 'human';
                
                return (
                    <div 
                        className="min-h-screen bg-gray-50 p-8"
                        onMouseMove={handleInteraction}
                        onScroll={handleInteraction}
                        onClick={handleInteraction}
                    >
                        <div className="max-w-3xl mx-auto">
                            <div className="bg-white rounded-lg shadow-md p-8">
                                <div className="flex items-center gap-4 mb-6 pb-6 border-b border-gray-200">
                                    <div className="flex-shrink-0">
                                        {isHuman ? (
                                            <div className="w-16 h-16 bg-gray-400 rounded-full flex items-center justify-center">
                                                <User />
                                            </div>
                                        ) : (
                                            <div className="w-16 h-16 bg-gray-700 rounded-lg flex items-center justify-center">
                                                <Cpu />
                                            </div>
                                        )}
                                    </div>
                                    <div>
                                        <h2 className="text-2xl font-bold text-gray-800">
                                            {isHuman ? 'Feedback from another participant' : 'Feedback from an AI system'}
                                        </h2>
                                        <p className="text-gray-600 mt-1">
                                            {isHuman 
                                                ? 'The feedback below was written by a prior participant after reviewing your responses.'
                                                : 'The feedback below was generated by an AI system that analyzes response quality.'}
                                        </p>
                                    </div>
                                </div>

                                <div className="space-y-4 mb-6">
                                    {feedbackOrder.map((item, index) => (
                                        <div 
                                            key={index}
                                            className="flex gap-3 p-4 bg-gray-50 rounded-md border border-gray-200"
                                        >
                                            <span className="text-gray-500 font-semibold flex-shrink-0">•</span>
                                            <p className="text-gray-700 leading-relaxed">{item.text}</p>
                                        </div>
                                    ))}
                                </div>

                                <div className="pt-6 border-t border-gray-200">
                                    {!canContinue ? (
                                        <div className="text-center">
                                            <p className="text-gray-600 mb-2">
                                                Please review the feedback carefully
                                            </p>
                                            <p className="text-sm text-gray-500">
                                                Continue button will appear in {30 - timeElapsed} seconds
                                            </p>
                                            <div className="mt-4 w-full bg-gray-200 rounded-full h-2">
                                                <div 
                                                    className="bg-blue-600 h-2 rounded-full transition-all duration-1000"
                                                    style={{ width: `${(timeElapsed / 30) * 100}%` }}
                                                />
                                            </div>
                                        </div>
                                    ) : (
                                        <button
                                            onClick={handleComplete}
                                            className="w-full bg-green-600 text-white py-3 px-6 rounded-md hover:bg-green-700 transition-colors font-semibold"
                                        >
                                            Continue to Next Section
                                        </button>
                                    )}
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            if (stage === 'complete') {
                return (
                    <div className="min-h-screen bg-gray-50 flex items-center justify-center p-4">
                        <div className="max-w-2xl w-full bg-white rounded-lg shadow-md p-8">
                            <div className="text-center mb-6">
                                <div className="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <svg className="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                                    </svg>
                                </div>
                                <h2 className="text-2xl font-bold text-gray-800 mb-2">Feedback Section Complete</h2>
                                <p className="text-gray-600">Thank you for reviewing the feedback carefully.</p>
                            </div>

                            <div className="bg-gray-50 rounded-lg p-6 mb-6">
                                <h3 className="font-semibold text-gray-800 mb-3">Session Summary:</h3>
                                <div className="space-y-2 text-sm text-gray-700">
                                    <p><span className="font-semibold">Participant ID:</span> {sessionData.participantId}</p>
                                    <p><span className="font-semibold">Condition:</span> {sessionData.condition === 'human' ? 'Human' : 'AI'}</p>
                                    <p><span className="font-semibold">Essay Word Count:</span> {sessionData.essayWordCount}</p>
                                    <p><span className="font-semibold">Analysis Wait Time:</span> 2:00</p>
                                    <p><span className="font-semibold">Feedback Viewing Time:</span> {sessionData.totalViewingTimeSeconds}s</p>
                                    <p><span className="font-semibold">Time to First Interaction:</span> {sessionData.timeToFirstInteractionSeconds}s</p>
                                </div>
                            </div>

                            <button
                                onClick={downloadCSV}
                                className="w-full bg-blue-600 text-white py-3 px-6 rounded-md hover:bg-blue-700 transition-colors font-semibold flex items-center justify-center gap-2"
                            >
                                <Download />
                                Download Session Data (CSV)
                            </button>

                            <p className="text-sm text-gray-500 mt-4 text-center">
                                In an actual study, participants would now continue to the next section (recall task, questionnaires, etc.)
                            </p>
                        </div>
                    </div>
                );
            }
        };

        ReactDOM.render(<FeedbackInterface />, document.getElementById('root'));
    </script>
</body>
</html>